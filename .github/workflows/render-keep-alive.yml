name: Keep Render Alive Ultra-Adaptive

on:
  schedule:
    - cron: '*/5 * * * *' # every 5 minutes
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest

    steps:
      - name: Self-adaptive ultra-smart ping
        run: |
          URL="https://mega-facebook-autoposter.onrender.com"

          # Ultra-random main wait 60-240 seconds
          MAIN_WAIT=$((RANDOM % 180 + 60))
          sleep $MAIN_WAIT

          # Adaptive ping function
          ping_app() {
            local retries=0
            local max_retries=5
            local success=0

            while [ $retries -lt $max_retries ]; do
              curl -s --max-time 10 "$URL" > /dev/null
              if [ $? -eq 0 ]; then
                success=1
                break
              fi
              # If failed, wait a small random time before retrying
              WAIT=$((RANDOM % 10 + 5))  # 5-14 seconds
              sleep $WAIT
              retries=$((retries + 1))
            done

            # If first attempts fail, do a secondary ping after random wait
            if [ $success -eq 0 ]; then
              SECONDARY_WAIT=$((RANDOM % 11 + 10))  # 10-20 sec
              sleep $SECONDARY_WAIT
              curl -s --max-time 10 "$URL" > /dev/null || true
            fi
          }

          # Execute adaptive ping
          ping_app

          # Extra tertiary ping after random 15-30 seconds for insurance
          TERTIARY_WAIT=$((RANDOM % 16 + 15))
          sleep $TERTIARY_WAIT
          curl -s --max-time 10 "$URL" > /dev/null || true
